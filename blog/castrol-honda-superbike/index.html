<!doctype html><html lang=en><head><meta charset=utf-8><link href=https://seri.tools/style.css rel=stylesheet><title>Why Castrol Honda Superbike crashes on (most) modern systems - seri.tools</title><meta name=description><meta content="Dennis Duda" name=author><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#292828 name=theme-color><link href=https://seri.tools/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://seri.tools/rss.xml rel=alternate title=RSS type=application/rss+xml><body bgcolor=#333333 fgcolor=#ded9c9><div class=all><div class=header><header><div class="float-right top-nav"><a href=https://seri.tools/blog>Posts</a> | <a href=https://seri.tools/atom.xml>Atom</a> | <a href=https://seri.tools/rss.xml>RSS</a></div><h1 class=title><a href=https://seri.tools title=seri.tools><strong>seri</strong>.tools</a></h1></header></div><div><main><div class=content><p class=post-date>Posted: 2025-11-16<h1><a href=#>Why Castrol Honda Superbike crashes on (most) modern systems</a></h1><p>A friend cleaned up and gave me a copy of a game I've not heard about before: <em>Castrol Honda Superbike World Champions</em>, a motorbike racing game for PC, released 1998 by Interactive Entertainment Ltd. and Midas Interactive Entertainment.<div class=center><a title="Picture of the jewelcase" href=https://seri.tools/blog/castrol-honda-superbike/jewelcase.webp> <img alt="Picture of the jewelcase" loading=lazy src=https://seri.tools/blog/castrol-honda-superbike/jewelcase.webp width=1024> </a></div><p>Given the age of the game (and looking at the system requirements) it's clear that the game comes from the tricky era of early 3D-accelerated PC gaming. For context, my copy of the game helpfully asks to install DirectX 5.<p>Before Windows was known for cramming AI and account requirements into every single corner of the system, no matter how unnecessary, it was known for its excellent backwards compatibility with older software. Generally, unless there are genuine bugs (and sometimes even despite them), Windows tries its hardest to run old applications correctly.<p>Pushing my luck and trying to run it on my Windows 7 machine, however, resulted in either a getting stuck on a black screen, or a crash, seemingly at random:<div class=center><a title="Crash dialog from Windows 7: bike.exe has stopped working" href=https://seri.tools/blog/castrol-honda-superbike/crash.webp> <img alt="Crash dialog from Windows 7: bike.exe has stopped working" loading=lazy src=https://seri.tools/blog/castrol-honda-superbike/crash.webp width=527> </a></div><p>Let's go back in time and see how far we need to go to get it running: Installing and running it on my Windows 98 and Windows XP machines was as uneventful, and the game works just fine<sup class=footnote-reference id=fr-1-1><a href=#fn-1>1</a></sup>, including with 3D acceleration. Glorious 1024x768x16:<div class=center><a title="Screencap ingame" href=https://seri.tools/blog/castrol-honda-superbike/ingame.webp> <img alt="Screencap ingame" loading=lazy src=https://seri.tools/blog/castrol-honda-superbike/ingame.webp width=1024> </a></div><h2 id=debugging-the-issue>Debugging the issue <a class=anchor href=#debugging-the-issue>#</a></h2><p>Debugging is more fun than playing, so let's get started! :^)<p>I pulled over the installation directory to my main machine and ran <a href=https://github.com/horsicq/Detect-It-Easy>Detect It Easy</a> to see what we can learn about the executable:<div class=center><a title="Screenshot of Detect It Easy with bike.exe loaded" href=https://seri.tools/blog/castrol-honda-superbike/die.webp> <img alt="Screenshot of Detect It Easy with bike.exe loaded" loading=lazy src=https://seri.tools/blog/castrol-honda-superbike/die.webp width=1440> </a></div><p><code>Linker: Microsoft Linker(5.10)</code> and <code>Compiler: Microsoft Visual C/C++(...)[libcmtd]</code> are the interesting bits here. Notice how it's <code>libcmtd</code>, not <code>libcmt</code>? The binary is linked against the static <em>debug</em> version of VC5's runtime. The debug runtime has heaps of extra checks and <a href=https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-outputdebugstringa>logging</a>, which might help later.<p>Let's attach a debugger and see what's going on. Given that the game crashes very early on (before the credits intro screen), I hoped to see something right away. The cases where the game got stuck in a loop seemed to actually get stuck in some Windows API call stack.<p>Anyway, the cases where it crashed gave a clearer starting point:<div class=center><a title="Stack trace from debugger" href=https://seri.tools/blog/castrol-honda-superbike/stack.webp> <img alt="Stack trace from debugger" loading=lazy src=https://seri.tools/blog/castrol-honda-superbike/stack.webp width=821> </a></div><p>The game seems to be stuck after a call to DirectInput's <code>DirectInputCreateEx</code> function. At this point I started to do some static analysis of the functions leading to this call. While doing that I noticed that the game seems to have quite extensive logging, anything from game initialization to memory allocations.<blockquote><p>If you're interested in all the logs, here are the config settings to enable them all:<ul><li>In <code>Config.dat</code>, switch <code>ErrorLog</code>, <code>FileLog</code>, <code>MallocLog</code> from <code>off</code> to <code>on</code>. <ul><li>These are the "normal" log files the game produces.<li><code>ErrorLog</code> produces <code>error.log</code>, which is the general log file.<li><code>FileLog</code> produces <code>files.log</code>, tracking all opened files and their access modes.<li><code>MallocLog</code> produces <code>malloc.log</code>, tracking all memory allocations and frees. The devs even kept descriptions for every allocation site!</ul><li>Set an environment variable named <code>errorfile</code> to any file name (not path). The game will write logs to that file in the game directory. <ul><li>You might also need to create an empty <code>*.c</code> file in the game directory.<li>Just gives a bit of extra logging.</ul></ul><p>Bonus: add a setting named <code>windowed=true</code> to the config file to force windowed mode; only works correctly in 16-bit mode (garbled graphics in True Color).</blockquote><p>After enabling all the logging, I ran the game a few more times, and noticed that the last log messages in <code>error.log</code> before the crash were these:<pre style=color:#e2cca9;background-color:#292828><code><span>0> Instance : Mouse
</span><span>0> Product : Mouse
</span><span>1> Instance : Keyboard
</span><span>1> Product : Keyboard
</span><span>2> Instance : Gaming Mouse G502
</span><span>2> Product : Gaming Mouse G502
</span><span>3> Instance : Gaming Mouse G502
</span><span>3> Product : Gaming Mouse G502
</span><span>4> Instance : Gaming Mouse G502
</span><span>4> Product : Gaming Mouse G502
</span><span>5> Instance : Gaming Mouse G502
</span><span>5> Product : Gaming Mouse G502
</span><span>6> Instance : USB Keyboard
</span><span>6> Product : USB Keyboard
</span><span>7> Instance : USB Keyboard
</span><span>7> Product : USB Keyboard
</span><span>8> Instance : LED Controller
</span><span>8> Product : LED Controller
</span></code></pre><p>Great, the game is enumerating input devices— uh, why is there an "LED Controller" device? The motherboard in my Windows 7 machine has a built-in LED controller, so that checks out. Maybe the detection isn't working properly, and the game is trying to use it as an input device?<p>After disabling the LED controller in Device Manager, the game started up just fine, consistently! So far, so good. Of course I wanted to know what was actually going wrong, though, so let's see where these messages are printed.<h2 id=side-quest-cd-check>Side quest: CD check <a class=anchor href=#side-quest-cd-check>#</a></h2><p>The game seemed to close without any notice if I forgot to insert the game disc. A quick trace showed that the <code>GibbonPosture</code> setting in <code>f1.cfg</code> is used to point to the disc drive from which the game was installed. The only check seems to be that the path <code>redist\dsetup.dll</code> exists on the disc. Copying the redist folder to the installation directory and changing the setting to <code>GibbonPosture=.\</code> seems to work just fine. :)<h2 id=the-bug>The bug <a class=anchor href=#the-bug>#</a></h2><p>Finding the <code>Instance :</code> and <code>Product :</code> log messages in the binary was easy enough. They are referenced in only one function, which is a <a href="https://learn.microsoft.com/en-us/previous-versions/windows/desktop/ee416622(v=vs.85)"><code>DIEnumDevicesCallback</code></a> callback function that is provided to <code>IDirectInput::EnumDevices</code> (Microsoft has only kept the documentation for the <a href="https://learn.microsoft.com/en-us/previous-versions/windows/desktop/ee417804(v=vs.85)">DX8 version</a> of EnumDevices left online, but it's close enough).<p>This is the pseudocode of the call and the callback, and the relevant data structure:<pre class=language-c data-lang=c style=color:#e2cca9;background-color:#292828><code class=language-c data-lang=c><span style=color:#f2594b>struct </span><span style=color:#8bba7f>DinputDeviceData
</span><span>{
</span><span>  </span><span style=color:#f2594b>char</span><span> instance_name[</span><span style=color:#d3869b>128</span><span>];
</span><span>  </span><span style=color:#f2594b>char</span><span> product_name[</span><span style=color:#d3869b>128</span><span>];
</span><span>  </span><span style=color:#e9b143>DWORD</span><span> dwDevType;
</span><span>  GUID guid;
</span><span>};
</span><span>
</span><span style=color:#928374;font-style:italic>// ...
</span><span>
</span><span style=color:#e9b143>BOOL</span><span> __stdcall </span><span style=color:#8bba7f>dinput_enumdevices_callback</span><span>(LPCDIDEVICEINSTANCEA </span><span style=color:#fdf4c1>lpDevice</span><span>, </span><span style=color:#e9b143>LPVOID </span><span style=color:#fdf4c1>pvRef</span><span>)
</span><span>{
</span><span>    </span><span style=color:#f2594b>int</span><span> index </span><span style=color:#f28534>=</span><span> g_dinput_device_index;
</span><span>    g_direct_input_devices[index].</span><span style=color:#fdf4c1>guid </span><span style=color:#f28534>=</span><span> lpDevice->guidInstance;
</span><span>    </span><span style=color:#e9b143>strcpy</span><span style=color:#fdf4c1>(g_direct_input_devices[index].instance_name, lpDevice->tszInstanceName)</span><span>;
</span><span>    </span><span style=color:#e9b143>strcpy</span><span style=color:#fdf4c1>(g_direct_input_devices[index].product_name, lpDevice->tszProductName)</span><span>;
</span><span>    g_direct_input_devices[index].</span><span style=color:#fdf4c1>dwDevType </span><span style=color:#f28534>=</span><span> lpDevice->dwDevType;
</span><span>
</span><span>    </span><span style=color:#fdf4c1>log_line(</span><span style=color:#b0b846>"</span><span style=color:#fdf4c1>%d</span><span style=color:#b0b846>> Instance : </span><span style=color:#fdf4c1>%s</span><span style=color:#b0b846>\n"</span><span style=color:#fdf4c1>, index, lpDevice->tszInstanceName)</span><span>;
</span><span>    </span><span style=color:#fdf4c1>log_line(</span><span style=color:#b0b846>"</span><span style=color:#fdf4c1>%d</span><span style=color:#b0b846>> Product : </span><span style=color:#fdf4c1>%s</span><span style=color:#b0b846>\n"</span><span style=color:#fdf4c1>, index, lpDevice->tszProductName)</span><span>;
</span><span>
</span><span>    </span><span style=color:#f2594b>if </span><span>( </span><span style=color:#fdf4c1>LOBYTE(g_direct_input_devices[index].dwDevType) </span><span style=color:#f28534>==</span><span> DIDEVTYPE_JOYSTICK )
</span><span>    {
</span><span>        </span><span style=color:#f2594b>int</span><span> joystick_index </span><span style=color:#f28534>=</span><span> g_joystick_index;
</span><span>        g_joystick_info[joystick_index].</span><span style=color:#fdf4c1>dinput_device_index </span><span style=color:#f28534>=</span><span> index;
</span><span>        g_joystick_info[joystick_index].</span><span style=color:#fdf4c1>field_4 </span><span style=color:#f28534>= </span><span style=color:#d3869b>0</span><span>;
</span><span>        g_joystick_info[joystick_index].</span><span style=color:#fdf4c1>field_8 </span><span style=color:#f28534>= </span><span style=color:#d3869b>0</span><span>;
</span><span>        g_joystick_info[joystick_index].</span><span style=color:#fdf4c1>field_38 </span><span style=color:#f28534>= </span><span style=color:#d3869b>0</span><span>;
</span><span>        g_joystick_info[joystick_index].</span><span style=color:#fdf4c1>field_1 </span><span style=color:#f28534>= </span><span style=color:#d3869b>0</span><span>;
</span><span>        g_joystick_index </span><span style=color:#f28534>=</span><span> joystick_index </span><span style=color:#f28534>+ </span><span style=color:#d3869b>1</span><span>;
</span><span>    }
</span><span>    g_dinput_device_index </span><span style=color:#f28534>=</span><span> index </span><span style=color:#f28534>+ </span><span style=color:#d3869b>1</span><span>;
</span><span>
</span><span>    </span><span style=color:#f2594b>return</span><span> DIENUM_CONTINUE;
</span><span>}
</span><span>
</span><span style=color:#928374;font-style:italic>// ...
</span><span>
</span><span>g_dinput_create_hresult </span><span style=color:#f28534>= </span><span style=color:#fdf4c1>DirectInputCreateA(hInstance, </span><span style=color:#d3869b>0x500</span><span style=color:#f2594b>u</span><span style=color:#fdf4c1>, </span><span style=color:#f28534>&</span><span style=color:#fdf4c1>g_dinput_instance, </span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>)</span><span>;
</span><span>g_dinput_device_index </span><span style=color:#f28534>= </span><span style=color:#d3869b>0</span><span>;
</span><span>g_joystick_index </span><span style=color:#f28534>= </span><span style=color:#d3869b>0</span><span>;
</span><span>g_dinput_instance->lpVtbl-></span><span style=color:#fdf4c1>EnumDevices(
</span><span style=color:#fdf4c1>    g_dinput_instance, </span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>, dinput_enumdevices_callback, </span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>, DIEDFL_ATTACHEDONLY)</span><span>;
</span></code></pre><p>So, for each enumerated device, the game stores some general information about it in the global array <code>g_direct_input_devices</code>. Then, if the device is a joystick (generally, a game controller), it also adds it to <code>g_joystick_info</code>.<p>Can you guess the bug yet? :) If not, here's the declaration of the global arrays:<pre class=language-c data-lang=c style=color:#e2cca9;background-color:#292828><code class=language-c data-lang=c><span>DinputDeviceData g_direct_input_devices[</span><span style=color:#d3869b>8</span><span>];
</span><span style=color:#928374;font-style:italic>// ...
</span><span>JoystickInfo g_joystick_info[</span><span style=color:#d3869b>8</span><span>];
</span></code></pre><p>There's only space for eight DirectInput devices in the array! <code>8> Instance : LED Controller</code> was the ninth one, overwriting lots of important other data in the process, including timer handles and the actual DirectInput instance pointer.<p>But it gets worse: The game uses DirectInput for game controllers only. Copying the device info out of <code>lpDevice</code> is entirely pointless for other types of devices. Just moving the <code>DIDEVTYPE_JOYSTICK</code> check up would have hidden the bug for basically all setups, since you'd have to have more than 8 game controllers connected for the game to write out of bounds.<p>Actually, there would've been an even simpler workaround: <code>EnumDevices</code> allows passing a <code>DIDEVTYPE</code> as a filter:<pre class=language-c data-lang=c style=color:#e2cca9;background-color:#292828><code class=language-c data-lang=c><span>g_dinput_instance->lpVtbl-></span><span style=color:#fdf4c1>EnumDevices(
</span><span style=color:#fdf4c1>    g_dinput_instance, DIDEVTYPE_JOYSTICK, dinput_enumdevices_callback, </span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>, DIEDFL_ATTACHEDONLY)</span><span>;
</span><span>                    </span><span style=color:#928374;font-style:italic>// ^^^^^^^^^^^^^^^^^^
</span></code></pre><p>This would make DirectInput call the callback for game controllers only. Without it, all devices, whether they are keyboards, mice, or actually any HID devices, are enumerated. (I've checked the DirectX 5 SDK docs, and even there it mentions the HID device support.) This includes the vendor-defined devices of my mouse and its emulated keyboard (for macros), and of course the motherboard's LED controller.<p>The moral of the story? Always check your bounds, kids! You'll never know if some weirdo comes along and plugs in a dozen game controllers to their PC. :^)<h2 id=the-fix>The fix <a class=anchor href=#the-fix>#</a></h2><p><a href=https://github.com/seritools/castrol-honda-dinput-fix>Over on GitHub</a> I've pushed a minimal patch as a classic DLL shim. With the provided <code>dinput.dll</code> in the game directory, the game will load that instead of the system one. DirectInput has only one relevant exported function that we need to shim: <code>DirectInputCreateA</code>. The rest of the API is implemented via COM interfaces, for which we can modify the respective vtables as needed.<p>I've implemented two fixes in the shim:<ol><li>Inject the <code>DIDEVTYPE_JOYSTICK</code> filter in the call to <code>EnumDevices</code> to only return joysticks/game controllers.<li>Cancel enumeration once 8 joysticks have been found.</ol><p>For fun, I've also tried to minimize the size of the shim DLL -- the final binary weighs in at 2 KiB.<blockquote><p>These are the reasonable settings I changed:<ul><li>Compile with <code>opt-level = "z"</code> to optimize for minimum size. (though the code is so low-level that it's effectively the same as <code>opt-level = 3</code>)<li><code>#[no_std]</code> to avoid linking the Rust standard library.<li><code>codegen-units = 1</code> and <code>lto = true</code> to enable whole-program optimization.<li><code>panic = "immediate-abort"</code> to remove all unnecessary panic handling code; an unwrap will immediately abort the process.</ul><p>And these are the cursed ones:<ul><li><code>/NODEFAULTLIB</code> to not link against any MSVC runtime library; added my own minimal <code>DllMain</code>.<li><code>/FORCE:UNRESOLVED</code> to ignore the missing symbols for <code>_aullrem</code>, <code>_aulldiv</code>, and <code>_fltused</code>. We aren't using any of these, but the LLVM target still seems to insist on linking them in.<li><code>/FILEALIGN:512</code> to force the linker to use the minimum supported PE section alignment in the file.<li><code>/MERGE:.rdata=.text</code> merges the read-only data section into the code section.<li>Prevent zero-initialization of the system directory path by using <code>MaybeUninit</code>.<li>Storing globals in <code>static mut</code> just like the original game does. Since the fix is specific to this game I can do these "global" assumptions here :^) <ul><li>Ensure all globals are zero-initialized so the <code>.data</code> section is 0 bytes in the binary.</ul><li><code>.unwrap_unchecked()</code> to avoid any extra branches where they aren't needed.<li><code>/DEBUG:NONE</code> to not generate debug information, and not store a <code>.pdb</code> path in the binary.</ul></blockquote><p>Furthermore, I switched to <code>rust-lld.exe</code> as the linker, as it's fine with setting <code>/SUBSYSTEM:WINDOWS,4.0"</code> and <code>/OSVERSION:4.0</code> without complaining. :) Since there is no linked runtime code at all, the resulting binary should work on any 32-bit Windows version, even without <a href=https://github.com/rust9x/rust/wiki>Rust9x</a>. I've tested it on Windows 7 and Windows 98 SE.<p>Feel free to grab the compiled DLL from the <a href=https://github.com/seritools/castrol-honda-dinput-fix/releases>releases page</a>.<section class=footnotes><ol class=footnotes-list><li id=fn-1><p>Except for True Color rendering, <a href=https://seri.tools/blog/castrol-honda-superbike/./truecolor.webp>which seems to be broken</a>, no matter the system, graphics card, or game version? Investigating that is left as a mystery for another day. <a href=#fr-1-1>↩</a></p></ol></section></div></main></div><div class=footer><hr><footer>Dennis Duda | <a href=https://github.com/seritools>github/seritools</a><br><a href=https://hachyderm.io/@seri rel=me>hachyderm.io/@seri</a> | <a href=https://bsky.app/profile/seritools.bsky.social>@seritools.bsky.social</a> | <a href=https://x.com/seritools>x/@seritools</a><br> Discord: @seritools | <a href=https://www.linkedin.com/in/seritools/>LinkedIn</a><br><a href=/legal>Legal</a></footer></div></div>